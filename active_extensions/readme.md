# Active Extensions CDR Parser

Скрипт предназначен для поиска активных номеров в CDR-файлах Avaya CM. 

## Перед началом работы
Скрипт работает на Linux, используя стандартные утилиты `bash`, `awk` и `sort` — они обычно уже есть в системе. CDR-файлы должны быть в доступной папке и соответствовать заданному шаблону (по умолчанию `cdr_YYYY-MM-DD_*.log`).

Чтобы начать, скачайте скрипт:
```bash
git clone https://github.com/SkyrocketStan/CDR-Tools.git
cd CDR-Tools/active_extensions
chmod +x active_extensions.sh
```

## Как использовать
Скрипт поддерживает несколько способов запуска — выбирайте подходящий:

- **Без параметров**: Ищет в текущей папке за последние 30 дней.
  ```bash
  ./active_extensions.sh
  ```
- **Только дни**: Укажите количество дней для поиска в текущей папке.
  ```bash
  ./active_extensions.sh 60
  ```
- **Только папка**: Укажите директорию с логами, поиск идёт за 30 дней.
  ```bash
  ./active_extensions.sh /var/log/cdr
  ```
- **Папка и дни**: Задайте и папку, и глубину поиска.
  ```bash
  ./active_extensions.sh /var/log/cdr 60
  ```
- **С опциями**: Для более точной настройки используйте параметры:
  - `--cdr-dir /path` — путь к папке с CDR-файлами.
  - `--days 45` — глубина анализа в днях.
  - `--debug` — включает подробный лог.
  - `--help` — показывает справку.
  Пример:
  ```bash
  ./active_extensions.sh --cdr-dir /var/log/cdr --days 45 --debug
  ```

Если ввели что-то не так, скрипт подскажет, как правильно.

## Результаты
- **Вывод**: Найденные номера сохраняются в файл с именем скрипта (например, `active_extensions.txt`), если не указано иное — только список номеров, ничего лишнего.
- **Лог**: Ход работы записывается в файл с именем скрипта (например, `active_extensions.log`). С опцией `--debug` добавляются детали: где и какие номера найдены.

## Тонкая настройка
Скрипт полностью настраиваемый. Откройте `active_extensions.sh` в текстовом редакторе и найдите в начале переменные:

```bash
# Параметры поиска
SEARCH_PATTERN="^[1-9][0-9]{5}$"  # Шестизначные номера, не начинающиеся с 0
MIN_LENGTH=6                      # Минимальная длина номера
MAX_LENGTH=6                      # Максимальная длина номера
SEARCH_MODE="full"                # "full" — по всей строке, "position" — по позициям
CALLING_POS=13                    # Позиция для calling-num
CALLING_LEN=10                    # Длина поля calling-num
DIALED_POS=62                     # Позиция для dialed-num
DIALED_LEN=18                     # Длина поля dialed-num

# Параметры файлов
LOG_PATTERN="cdr_%Y-%m-%d_*.log"  # Шаблон имени CDR-файлов
OUTPUT_FILE_NAME=""               # Имя выходного файла (пусто = по имени скрипта)
LOG_FILE_NAME=""                  # Имя лог-файла (пусто = по имени скрипта)
```

### Варианты настройки
- **Стандартный поиск**: Оставьте как есть — ищет шестизначные номера по всей строке.
- **Пятизначные номера**:
  ```bash
  SEARCH_PATTERN="^[1-9][0-9]{4}$"
  MIN_LENGTH=5
  MAX_LENGTH=5
  ```
- **Изменённый формат CDR**: Переключите режим и задайте новые позиции и длины.
  ```bash
  SEARCH_MODE="position"
  CALLING_POS=20
  CALLING_LEN=12
  DIALED_POS=70
  DIALED_LEN=15
  ```
- **Другой шаблон файлов**: Если ваши логи называются иначе.
  ```bash
  LOG_PATTERN="avaya_log_%Y%m%d_*.txt"
  ```
- **Другие имена файлов**: Задайте свои имена вместо использования имени скрипта.
  ```bash
  OUTPUT_FILE_NAME="numbers.txt"
  LOG_FILE_NAME="process.log"
  ```

Сохраните изменения, и скрипт адаптируется под ваши требования.

## Дополнительно
Скрипт универсален: ищет либо по всей строке, либо по заданным позициям и длинам полей. Имена выходных файлов по умолчанию совпадают с именем скрипта (без `.sh`), но их можно переопределить. Если формат CDR или имена файлов изменятся, обновите переменные. Возникли вопросы или предложения? Пишите в [Issues на GitHub](https://github.com/SkyrocketStan/CDR-Tools/issues) — разберёмся вместе.
